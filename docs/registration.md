# Registration of Users

The registration procedure has several steps in common with [the authentication one](./authentication.md).
Below we describe the steps for two OAuth 2 strategy: authentication code flow and
resource password flow.

## Authentication Code Flow

This scenario is good for creating web applications because it uses browser redirections.
To start you need to request the authentication server (same as for [the authentication](./authentication.md)).

```bash
APP_ID=... app\_id ...
REDIRECT_URL=...

curl $AUTH_HOST/auth/oauth/authorize?response_type=code&client_id=$APP_ID&redirect_uri=$REDIRECT_URL&scope=full 
```

Here it is supposed that you have already [created a new application](./applications/applications.md)
and have received its app_id and set the redirection url.

Then, the main registration activity goes on the authentication server:

* The user is asked to enter their mobile phone number
* The authentication server determines that the user has no account before and sends him or her the PIN
  which is generated by the server as an SMS message.
* Then user should enter this new PIN-code and the server does redirect back to the redirection url.

Finally, the browser is redirected to the following url:

```
   $REDIRECT_URL?code=JKrjHw
```

and to obtain a token please use the request:

```bash
APP_ID=...app_id...
APP_SECRET=...app_secret...
CODE=... the code from the authentication server response ...
REDIRECT_URL=...

curl -X POST -H "Accept: application/json" \
             -d "client_id=$APP_ID&client_secret=$APP_SECRET&grant_type=authorization_code&code=$CODE&redirect_uri=$REDIRECT_URL" \
             $AUTH_HOST/auth/oauth/token
```

The result will look like this:

```json
{
  "access_token": "06935b2e-6639-4b49-8c8a-71452082a420" ,
  "token_type": "bearer" ,
  "refresh_token": "c01b926a-cf78-4b43-be92-5fe21ef712d0" ,
  "expires_in": 1209599 ,
  "scope": "full" ,
  "client_id": "..."
}
```

Because during the registration procedure the user has already entered the PIN-code from the SMS message,
no need to query for an OTP as it is done for the authentication. The token is already fully authenticated.

Bear in mind the registration procedure for both SMS and USSD channels is the same. No OTP is sent and even
no USSD interaction takes place.

## Resource Password Flow

The resource password flow is good for creating mobile application or custom integrations that do not require
browser interaction.

The registration process should start from checking whether the user has probably an account in the system.
It can be accomplished by the following url:

```bash
MODEL='{"login": "+6598094345", "client_id": "myapp"}'

curl -X PUT -d "$MODEL" $AUTH_HOST/auth/api/v1/registration/silent
```

Here is the 'login' field is the mobile phone number of the user. The 'client_id' allows
you to link the registration messages to you application with the given 'app_id'.
The 'client_id' attribute means here the identifier of your application.
Please refer to the [application section](./applications/applications.md) and
[provider section](./models/provider.md) for more information on custom applications.

For new users the result will look like this:

```json
{
  "code": 0 ,
  "state": "New" ,
  "login": "6598094345" ,
  "name": "baf640ce-f6d9-4609-9815-5d2d476e2362" ,
  "agreement": false ,
  "agreement_type": "nonrelevant"
}
```

The 'state' field indicates that the user is a new. If the state has other value
(like 'Confirmed' or 'Active'), you can't continue registration because the user
has already registered. In this case please use [the authentication procedure](./authentication.md).

Other fields give more information on the user. The 'agreement' field shows us that
the user also did not accept the User Agreement during registration. This may be
useful to understand at what step the registration has been interrupted previously.

Further steps are connected with requesting an OTP to check the mobile phone number
really belongs to the user. Please use [Querying an OTP](./authentication.md#querying-an-otp)
and [Obtaining a token](./authentication.md#obtaining-a-token).

After that you will be in the situation when the [role query](./authentication.md#check-user-roles)
gives the value 'ROLE_SET_PASSWORD'. That means you need to make the user set a new
PIN-code.

It is conducted by the following query:

```bash
curl -X PUT -H "Authorization: Bearer $TOKEN" \
            -d '{"pin": "..."}' $AUTH_HOST/auth/api/v1/pin/set
```

If the PIN has been set correctly, then the user will get the 'ROLE\_USER' role which means the user is
fully authenticated.

### Sign the User Agreement

Before starting any actions in the application, the user must sign the User Agreement.
The text of the agreement depends on the concrete application/installation of
the platform and your developer's intentions.

From the point of developers you need to perform the following request to get
the user's acceptance of the agreement:

```bash
MODEL='{"agreement": true, "agreement_type": "relevant" }'

curl -X PUT -H "Authorization: Bearer $TOKEN" \
            -d "$MODEL" $API_HOST/api/v1/agreements
```  

The 'true' value of the 'agreement' field means the expression of agreement with
the conditions of the document from the user's side. The 'agreement_type' attribute
has two possible values: 'nonrelevant' and 'relevant'. The platform
supports two different modes for customers: the 'non-relevant' and the 'relevant'.

The non-relevant mode supposes some restrictions for users, e.g. they are unable
to have more than certain amount on their accounts, or they can't transfer funds.
But this mode requires the minimum of the customer data from the point of KYC.

The relevant mode is applied when the customer is agreed to pass the KYC procedures
and in this case the full functionality of the system will be available.

From the point of the User Agreement it may require two different documents to be signed.
If for your business activity is no need to have two different User Agreements,
you are enough to ask your user to sign just only one 'relevant' agreement on the start.

## Further Steps after Registration

There are several other steps which are required for users after completion of
the actions described above:

* Ask your customer for their [email address](./models/contact.md). The main email
  address can be used for
  communications with the customer and for restoring the account access if the customer forgot the PIN.
* Ask your customer to fulfill the basic form with [the customer data](./profile/individuals.md).
* Encourage your customer to pass the [KYC procedures](./profile/individuals.md).

All operations connected with money are unavailable until the customer provides their
email and basic profile data. Passing the KYC procedure opens the full functionality
for the customer. If some of this step is needed to be completed for a specific operation,
the system will notify the customer by raising an error.



